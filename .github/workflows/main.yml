name: Build AutoIt3

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download and Install AutoIt3
        run: |
          Invoke-WebRequest -Uri "https://www.autoitscript.com/cgi-bin/getfile.pl?autoit3/autoit-v3-setup.exe" -OutFile "autoit-setup.exe"
          Write-Host "Starting AutoIt silent install..."
          Start-Process -FilePath "autoit-setup.exe" -ArgumentList "/S" -Wait
          Write-Host "AutoIt install finished. Giving it a moment to settle..."
          Start-Sleep -Seconds 5 # Give a few seconds for file system to be ready
          
      - name: Verify AutoIt Installation
        run: |
          $compiler_path = "C:\Program Files (x86)\AutoIt3\Aut2Exe\Aut2exe.exe"
          if (-not (Test-Path $compiler_path)) {
            Write-Error "Compiler not found at '$compiler_path'!"
            Write-Host "Searching for 'Aut2exe.exe' in Program Files..."
            Get-ChildItem -Path "C:\Program Files", "C:\Program Files (x86)" -Filter "Aut2exe.exe" -Recurse -ErrorAction SilentlyContinue | Format-List Directory, FullName
            exit 1
          }
          Write-Host "✓ AutoIt Compiler found at $compiler_path"
          
      - name: Compile AutoIt3 script with icon
        run: |
          $compiler_path = "C:\Program Files (x86)\AutoIt3\Aut2Exe\Aut2exe.exe"
          
          Write-Host "Running compilation..."
          
          & $compiler_path /in "MinimizeToTray.au3" /out "MinimizeToTray.exe" /nopack /icon "MTT.ico"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Compilation failed with exit code $LASTEXITCODE"
            exit 1
          }
          
          Write-Host "✓ Compilation completed"
      
      - name: Verify compiled file
        run: |
          if (Test-Path "MinimizeToTray.exe") {
            Write-Host "✓ MinimizeToTray.exe found"
            Get-Item "MinimizeToTray.exe" | Format-List
          } else {
            Write-Error "✗ MinimizeToTray.exe not found!"
            Write-Host "Listing all files in current directory:"
            Get-ChildItem -Recurse
            exit 1
          }
          
      - name: Upload compiled executable and language files
        uses: actions/upload-artifact@v4
        with:
          name: MinimizeToTray
          path: |
            MinimizeToTray.exe
            language_gen/**
