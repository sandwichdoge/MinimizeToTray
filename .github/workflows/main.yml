name: Build AutoIt3

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download and Install AutoIt3
        run: |
          Invoke-WebRequest -Uri "https://www.autoitscript.com/cgi-bin/getfile.pl?autoit3/autoit-v3-setup.exe" -OutFile "autoit-setup.exe"
          Write-Host "Starting AutoIt silent install..."
          Start-Process -FilePath "autoit-setup.exe" -ArgumentList "/S" -Wait
          Write-Host "AutoIt install finished. Giving it a moment to settle..."
          Start-Sleep -Seconds 5 # Give a few seconds for file system to be ready
          
      - name: Verify AutoIt Installation
        run: |
          $compiler_path = "C:\Program Files (x86)\AutoIt3\Aut2Exe\Aut2exe.exe"
          if (-not (Test-Path $compiler_path)) {
            Write-Error "Compiler not found at '$compiler_path'!"
            Write-Host "Searching for 'Aut2exe.exe' in Program Files..."
            Get-ChildItem -Path "C:\Program Files", "C:\Program Files (x86)" -Filter "Aut2exe.exe" -Recurse -ErrorAction SilentlyContinue | Format-List Directory, FullName
            exit 1
          }
          Write-Host "✓ AutoIt Compiler found at $compiler_path"

      - name: Disable Windows Defender
        run: |
          Set-MpPreference -DisableRealtimeMonitoring $true
          Write-Host "Windows Defender real-time monitoring disabled"


      - name: Compile AutoIt3 script with icon
        timeout-minutes: 5
        run: |
          $compiler_path = "C:\Program Files (x86)\AutoIt3\Aut2Exe\Aut2exe.exe"
          
          # Verify compiler exists
          if (-not (Test-Path $compiler_path)) {
            Write-Error "Compiler not found at: $compiler_path"
            exit 1
          }
          
          Write-Host "Running compilation..."
          Write-Host "Current directory: $(Get-Location)"
          
          # List files to confirm they exist
          Write-Host "Files in directory:"
          Get-ChildItem | Format-Table Name
          
          # Create temp files for output
          $stdoutFile = New-TemporaryFile
          $stderrFile = New-TemporaryFile
          
          try {
            $process = Start-Process -FilePath $compiler_path `
              -ArgumentList '/in', 'MinimizeToTray.au3', '/out', 'MinimizeToTray.exe', '/nopack', '/icon', 'MTT.ico' `
              -NoNewWindow `
              -PassThru `
              -RedirectStandardOutput $stdoutFile.FullName `
              -RedirectStandardError $stderrFile.FullName
            
            Write-Host "Process started with PID: $($process.Id)"
            
            # Wait with timeout
            $timeout = 60 # seconds
            $elapsed = 0
            while (-not $process.HasExited -and $elapsed -lt $timeout) {
              Start-Sleep -Seconds 1
              $elapsed++
              if ($elapsed % 5 -eq 0) {
                Write-Host "Still running... ($elapsed seconds)"
              }
            }
            
            if (-not $process.HasExited) {
              Write-Host "Process timed out after $timeout seconds. Killing process..."
              $process.Kill()
              Write-Error "Compilation timed out"
              exit 1
            }
            
            $exitCode = $process.ExitCode
            $stdout = Get-Content $stdoutFile.FullName -Raw -ErrorAction SilentlyContinue
            $stderr = Get-Content $stderrFile.FullName -Raw -ErrorAction SilentlyContinue
            
            Write-Host "Exit code: $exitCode"
            Write-Host "STDOUT: $stdout"
            Write-Host "STDERR: $stderr"
            
            if ($exitCode -ne 0) {
              Write-Error "Compilation failed with exit code $exitCode"
              exit 1
            }
            
            Write-Host "✓ Compilation completed successfully"
            
          } finally {
            Remove-Item $stdoutFile.FullName -ErrorAction SilentlyContinue
            Remove-Item $stderrFile.FullName -ErrorAction SilentlyContinue
          }
      
      - name: Verify compiled file
        run: |
          if (Test-Path "MinimizeToTray.exe") {
            Write-Host "✓ MinimizeToTray.exe found"
            Get-Item "MinimizeToTray.exe" | Format-List
          } else {
            Write-Error "✗ MinimizeToTray.exe not found!"
            Write-Host "Listing all files in current directory:"
            Get-ChildItem -Recurse
            exit 1
          }
          
      - name: Upload compiled executable and language files
        uses: actions/upload-artifact@v4
        with:
          name: MinimizeToTray
          path: |
            MinimizeToTray.exe
            language_gen/**
